<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NewTon DC - Tournament Manager</title>
    <link rel="stylesheet" href="styles.css">

    <script>
        // Initialize help system when DOM is ready
        document.addEventListener('DOMContentLoaded', function () {
            // Load help system after other initialization
            setTimeout(() => {
                if (typeof initializeHelpSystem === 'function') {
                    initializeHelpSystem();
                }
            }, 500);
        });
    </script>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <h1>
                    <div id="clubLogo" class="logo-placeholder">
                        CLUB<br>LOGO
                    </div>
                    NewTon DC - Tournament Manager
                </h1>
            </div>
            <div class="nav">
                <button class="nav-btn active" data-page="setup">Setup</button>
                <button class="nav-btn" data-page="registration">Registration</button>
                <button class="nav-btn" data-page="tournament">Tournament</button>
                <button class="nav-btn" data-page="config">Config</button>
                <!-- NEW: Tournament status moved to bottom right of header -->
                <div id="headerTournamentStatus" class="header-tournament-status">
                    Tournament: <strong>None</strong>
                </div>
            </div>
        </div>

        <!-- Setup Page -->
        <div id="setup" class="page active setup-page-flex">
            <div class="setup-page-header">
                <h2>Tournament Setup</h2>
                <div class="tournament-info">
                    <div class="form-group">
                        <label for="tournamentName">Tournament Name</label>
                        <input type="text" id="tournamentName" placeholder="Enter tournament name">
                    </div>
                    <div style="display: flex; gap: 10px; align-items: end; margin-bottom: 20px;">
                        <div style="max-width: 250px;">
                            <label for="tournamentDate" style="display: block; margin-bottom: 6px; font-weight: 700; color: #111827;">Tournament Date</label>
                            <input type="date" id="tournamentDate" style="width: 100%; padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; color: #111827; background: #ffffff;">
                        </div>
                        <button class="btn btn-success" onclick="createTournament()" style="margin-bottom: 3px;">Create New Tournament</button>
                    </div>
                </div>

                <div class="form-group">
                    <button class="btn btn-warning" onclick="exportTournament()">Export Tournament</button>
                    <button class="btn" onclick="document.getElementById('importFile').click()">Import Tournament</button>
                    <button class="btn btn-warning" onclick="resetTournament()">Reset Tournament</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;"
                        onchange="importTournament(event)">
                </div>

                <div id="tournamentStatus" class="alert alert-info">
                    No active tournament
                </div>

                <div id="importStatus" class="alert" style="display: none; margin-top: 10px;">
                    <!-- Import status messages will appear here -->
                </div>
            </div>

            <div class="two-column-container setup-page-main">
                <div class="scrollable-column">
                    <h3>Recent Tournaments
                        <button class="btn" id="toggleTournamentsBtn" onclick="toggleTournamentView()">Show All</button>
                    </h3>
                    <div class="scrollable-column-content">
                        <div id="recentTournaments">
                            <p>No tournaments found</p>
                        </div>
                    </div>
                </div>
                
                <div class="scrollable-column">
                    <h3>Match Results</h3>
                    <div class="scrollable-column-content">
                        <div id="matchResults">
                            <p style="color: #6b7280; font-style: italic;">No match results yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Registration Page -->
        <div id="registration" class="page registration-page-flex">
            <div class="registration-page-header">
                <h2>Player Registration</h2>

                <div class="form-group">
                    <label for="playerName">Add New Player</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="playerName" placeholder="Enter player name" style="flex: 1; margin-bottom: 9px;">
                        <button class="btn btn-success" onclick="addPlayer()">Add Player</button>
                    </div>
                </div>

                <div class="d-flex justify-between align-center mt-20 mb-20">
                    <h3>Players (<span id="playerCount">0</span> total, <span id="paidCount">0</span> paid)</h3>
                    <div>
                        <button class="btn btn-success" onclick="exportResultsJSON()">Export JSON</button>
                        <button class="btn btn-success" onclick="exportResultsCSV()">Export CSV</button>
                        <button class="btn btn" onclick="showPage('tournament')">Go to tournament page</button>
                    </div>
                </div>
            </div>

            <!-- Two-column layout: Player cards left, Results table right -->
            <div class="registration-layout registration-page-main">
                <div class="players-column">
                    <div id="playersContainer" class="players-list">
                        <!-- Players will be added here -->
                    </div>
                </div>

                <div class="results-column">
                    <!-- Results Section -->
                    <div id="resultsSection">
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Player</th>
                                    <th>Points</th>
                                    <th>Short Legs</th>
                                    <th>High Outs</th>
                                    <th>180s</th>
                                    <th>Tons</th>
                                    <th>Legs Won</th>
                                    <th>Legs Lost</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tournament Page -->
        <div id="tournament" class="page">
            <div class="bracket-container">
                <div class="bracket-controls">
                    <!-- Top row -->
                    <div class="bracket-controls-top">
                        <div class="bracket-controls-top-left">
                            <button class="zoom-btn" onclick="generateBracket()" title="Generate Bracket">Generate
                                Bracket</button>
                            <button class="zoom-btn" onclick="showMatchCommandCenter()"
                                title="Show LIVE and UPCOMING matches">➹ Match Controls</button>
                        </div>
                        <div class="bracket-controls-top-right">
                            <button class="zoom-btn" onclick="zoomOut()" title="Zoom Out">−</button>
                        </div>
                    </div>

                    <!-- Middle row -->
                    <div class="bracket-controls-middle">
                        <div class="bracket-controls-middle-left">
                            <button class="zoom-btn" onclick="showPage('registration')"
                                title="Exit Tournament to edit statistics and see current results">⬅
                                Players/Points</button>
                        </div>
                        <div class="bracket-controls-middle-right">
                            <button class="zoom-btn" onclick="resetZoom()" title="Reset Zoom">⌂</button>
                        </div>
                    </div>

                    <!-- Bottom row -->
                    <div class="bracket-controls-bottom">
                        <div class="bracket-controls-bottom-left">
                            <!-- Empty - Players/Points moved to middle row -->
                        </div>
                        <div class="bracket-controls-bottom-right">
                            <button class="zoom-btn" onclick="zoomIn()" title="Zoom In">+</button>
                        </div>
                    </div>
                </div>
                <div class="bracket-watermarks">
                    <div class="watermark-left" id="watermark-left">
                        NewTon DC Tournament Manager (Press F1 for help)
                    </div>
                    <div class="watermark-right" id="watermark-right">
                        No Tournament
                    </div>
                </div>

                <div class="bracket-viewport" id="bracketViewport">
                    <div class="bracket-canvas" id="bracketCanvas">
                        <!--<div class="bracket-title back">BACKSIDE</div>
                        <div class="bracket-title front">FRONTSIDE</div> -->

                        <div id="bracketMatches">
                            <!-- Bracket matches will be rendered here -->
                        </div>

                        <div id="bracketLines">
                            <!-- Connection lines will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration Page -->
        <div id="config" class="page">
            <h2>Tournament Configuration</h2>
            </br>

            <div class="config-section">
                <h3>Logo</h3>
                <div class="config-grid">
                    <div class="form-group">
                        <label for="applicationTitle">To change the logo, place a square image with the name logo.png,
                            logo.jpg, logo.jpeg, or logo.svg in the folder that contains the file
                            tournament.html.</label>
                    </div>
                </div>
            </div>

            <div class="config-section">
                <h3>Application Settings</h3>
                <div class="config-grid">
                    <div class="form-group">
                        <label for="applicationTitle">Application Title</label>
                        <input type="text" id="applicationTitle" value="NewTon DC - Tournament Manager"
                            placeholder="Your Club - Tournament Manager">
                    </div>
                </div>
                <button class="btn btn-success" onclick="saveApplicationSettings()">Save Application Settings</button>
            </div>

            <div class="config-section">
                <h3>Point Values (autosave)</h3>
                <div class="config-grid">
                    <div class="form-group">
                        <label for="participationPoints">Participation Points</label>
                        <input type="number" id="participationPoints" value="5" min="0">
                    </div>
                    <div class="form-group">
                        <label for="firstPlacePoints">1st Place Points</label>
                        <input type="number" id="firstPlacePoints" value="15" min="0">
                    </div>
                    <div class="form-group">
                        <label for="secondPlacePoints">2nd Place Points</label>
                        <input type="number" id="secondPlacePoints" value="13" min="0">
                    </div>
                    <div class="form-group">
                        <label for="thirdPlacePoints">3rd Place Points</label>
                        <input type="number" id="thirdPlacePoints" value="10" min="0">
                    </div>
                    <div class="form-group">
                        <label for="fourthPlacePoints">4th Place Points</label>
                        <input type="number" id="fourthPlacePoints" value="9" min="0">
                    </div>
                    <div class="form-group">
                        <label for="fifthSixthPlacePoints">5th-6th Place Points</label>
                        <input type="number" id="fifthSixthPlacePoints" value="8" min="0">
                    </div>
                    <div class="form-group">
                        <label for="seventhEighthPlacePoints">7th-8th Place Points</label>
                        <input type="number" id="seventhEighthPlacePoints" value="7" min="0">
                    </div>
                    <div class="form-group">
                        <label for="highOutPoints">High Out Points (101+)</label>
                        <input type="number" id="highOutPoints" value="1" min="0">
                    </div>
                    <div class="form-group">
                        <label for="tonPoints">Ton Points (100+)</label>
                        <input type="number" id="tonPoints" value="0" min="0">
                    </div>
                    <div class="form-group">
                        <label for="shortLegPoints">Short Leg Points</label>
                        <input type="number" id="shortLegPoints" value="1" min="0">
                    </div>
                    <div class="form-group">
                        <label for="oneEightyPoints">180 Points</label>
                        <input type="number" id="oneEightyPoints" value="1" min="0">
                    </div>
                </div>
            </div>

            <div class="config-section">
                <h3>Match Configuration (autosave)</h3>
                <div class="config-grid">
                    <div class="form-group">
                        <label for="regularRoundsLegs">Regular Rounds</label>
                        <select id="regularRoundsLegs">
                            <option value="3" selected>Best of 3</option>
                            <option value="5">Best of 5</option>
                            <option value="7">Best of 7</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="backsideSemifinalLegs">Backside Semifinal</label>
                        <select id="backsideSemifinalLegs">
                            <option value="3" selected>Best of 3</option>
                            <option value="5">Best of 5</option>
                            <option value="7">Best of 7</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="frontsideSemifinalLegs">Frontside Semifinal</label>
                        <select id="frontsideSemifinalLegs">
                            <option value="3">Best of 3</option>
                            <option value="5" selected>Best of 5</option>
                            <option value="7">Best of 7</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="backsideFinalLegs">Backside Final</label>
                        <select id="backsideFinalLegs">
                            <option value="3">Best of 3</option>
                            <option value="5" selected>Best of 5</option>
                            <option value="7">Best of 7</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="grandFinalLegs">Grand Final</label>
                        <select id="grandFinalLegs">
                            <option value="3">Best of 3</option>
                            <option value="5" selected>Best of 5</option>
                            <option value="7">Best of 7</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="config-section">
                <h3>Lane Management</h3>
                <div class="config-grid">
                    <div class="form-group">
                        <label for="maxLanes">Maximum Number of Lanes</label>
                        <select id="maxLanes">
                            <option value="1">1 Lane</option>
                            <option value="2">2 Lanes</option>
                            <option value="3">3 Lanes</option>
                            <option value="4">4 Lanes</option>
                            <option value="5">5 Lanes</option>
                            <option value="6">6 Lanes</option>
                            <option value="7">7 Lanes</option>
                            <option value="8">8 Lanes</option>
                            <option value="9">9 Lanes</option>
                            <option value="10" selected>10 Lanes</option>
                            <option value="11">11 Lanes</option>
                            <option value="12">12 Lanes</option>
                            <option value="13">13 Lanes</option>
                            <option value="14">14 Lanes</option>
                            <option value="15">15 Lanes</option>
                            <option value="16">16 Lanes</option>
                            <option value="17">17 Lanes</option>
                            <option value="18">18 Lanes</option>
                            <option value="19">19 Lanes</option>
                            <option value="20">20 Lanes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="excludedLanes">Excluded Lanes (comma-separated)</label>
                        <input type="text" id="excludedLanes" placeholder="e.g. 5,7,9"
                               style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <small style="display: block; color: #666; margin-top: 4px;">
                            Enter lane numbers to exclude from assignment
                        </small>
                    </div>
                </div>
                <!-- Checkbox OUTSIDE the config-grid, so it appears below -->
                <!-- <div class="form-group" style="margin-top: 16px;">
                    <label>
                        <input type="checkbox" id="requireLaneForStart" style="margin-right: 8px;">
                        Require lane assignment before starting match
                    </label>
                </div> -->
                <button class="btn btn-success" onclick="saveLaneConfiguration()">Save Lane Settings</button>
                <button class="btn" onclick="showLaneUsage()">Show Current Lane Usage</button>
            </div>

            <div class="config-section">
                <h3>User Interface</h3>
                <div class="config-grid">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="confirmWinnerSelection" checked style="margin-right: 8px;">
                            Show confirmation dialog when selecting match winner
                        </label>
                    </div>
                </div>
                <button class="btn btn-success" onclick="saveUIConfiguration()">Save UI Settings</button>
            </div>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div id="statsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeStatsModal()">&times;</span>
            <h3 id="statsPlayerName">Player Statistics</h3>

            <div class="form-group">
                <label>Short Legs (max 21 darts)</label>
                <input type="number" id="statsShortLegDarts" min="9" max="21" placeholder="Enter dart count">
                <button class="btn" onclick="addShortLeg()" style="margin-top: 5px;">Add Short Leg</button>
            </div>

            <div class="form-group">
                <label>High Out Score (101+)</label>
                <input type="number" id="statsHighOut" min="101" max="170" placeholder="Enter high out score">
                <button class="btn" onclick="addHighOut()" style="margin-top: 5px;">Add High Out</button>
            </div>

            <div class="form-group">
                <label>180s</label>
                <div style="display: flex; align-items: center; height: 45px;">
                    <button class="btn" onclick="decrement180s()"
                        style="padding: 8px 12px; margin-right: 2px;">−</button>
                    <button class="btn" onclick="increment180s()"
                        style="padding: 8px 12px; margin-left: 1px;">+</button>
                    <span id="current180sCount" style="margin-left: 8px; font-weight: bold; font-size: 1.0em;">Current:
                        0</span>
                </div>
            </div>

            <div class="form-group">
                <label>Tons (100+)</label>
                <div style="display: flex; align-items: center; height: 45px;">
                    <button class="btn" onclick="decrementTons()"
                        style="padding: 8px 12px; margin-right: 2px;">−</button>
                    <button class="btn" onclick="incrementTons()"
                        style="padding: 8px 12px; margin-left: 1px;">+</button>
                    <span id="currentTonsCount" style="margin-left: 8px; font-weight: bold; font-size: 1.0em;">Current:
                        0</span>
                </div>
            </div>

            <!-- Lists grouped together at the bottom -->
            <div id="shortLegsList"></div>
            <div id="highOutsList"></div>

            <div style="margin-top: 20px;">
                <button class="btn btn-success" onclick="saveStats()">Save Statistics</button>
                <button class="btn" onclick="closeStatsModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Load JavaScript files in the correct order -->
    <script src="main.js"></script>
    <script src="lane-management.js"></script>
    <script src="tournament-management.js"></script>
    <script src="player-management.js"></script>
    <script src="clean-match-progression.js"></script>
    <script src="bracket-rendering.js"></script>
    <script src="results-config.js"></script>
    <script src="dynamic-help-system.js"></script>

    <footer>
        <span id="footerContent">NewTon DC Tournament Manager</span></br> Created by Håvard Skrödahl, NewTon DC Malmö
    </footer>

    <!-- Updated Winner Confirmation Modal with validation -->
    <div id="winnerConfirmModal" class="modal">
        <div class="modal-content">
            <h3 id="winnerConfirmTitle">Confirm Match Winner</h3>
            <div id="winnerConfirmMessage" style="margin: 20px 0; line-height: 1.5;">
                <!-- Message will be populated by JavaScript -->
            </div>

            <!-- Enhanced leg scores section with validation -->
            <div id="legScoresSection"
                style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e5e7eb;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span style="font-weight: 600; color: #111827;">Final Score (optional):</span>
                    <small style="color: #6b7280; font-style: italic;">Winner must have more legs than loser</small>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center;">
                        <span id="winnerNameForLegs"
                            style="font-weight: 600; color: #065f46; margin-right: 10px; min-width: 80px;">Winner</span>
                        <input type="number" id="winnerLegs" min="0" max="7"
                            style="width: 60px; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; text-align: center;">
                        <span style="margin: 0 8px; color: #6b7280;">legs</span>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <span id="loserNameForLegs"
                            style="font-weight: 600; color: #6b7280; margin-right: 10px; min-width: 80px;">Loser</span>
                        <input type="number" id="loserLegs" min="0" max="7" value="0"
                            style="width: 60px; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; text-align: center;">
                        <span style="margin: 0 8px; color: #6b7280;">legs</span>
                    </div>
                </div>
                <!-- Validation message will be inserted here by JavaScript -->
            </div>

            <div class="text-center mt-20">
                <button class="btn" id="winnerConfirmCancel"
                    style="margin-right: 15px; background: #6c757d; font-weight: 600;">Cancel</button>
                <button class="btn btn-success" id="winnerConfirmOK">Confirm Winner</button>
            </div>
        </div>
    </div>

    <!-- Match Controls Modal -->
    <div id="matchDetailsModal" class="modal">
        <div class="modal-content">
            <h3 id="matchDetailsTitle">Match Controls</h3>
            <div id="matchDetailsMessage" style="margin: 20px 0; line-height: 1.5; font-family: monospace; white-space: pre-line;">
                <!-- Match details will be populated by JavaScript -->
            </div>
            <div class="text-center mt-20">
                <button class="btn" id="matchDetailsOK" style="background: #065f46;">OK</button>
            </div>
        </div>
    </div>

    <!-- Match Controls Modal -->
    <div id="matchCommandCenterModal" class="modal">
        <div class="modal-content match-controls-modal" style="max-width: 1100px;">
            <h3 id="commandCenterTitle">Match Controls</h3>

            <div class="match-controls-main-container">
                <div class="match-controls-container">
                    <!-- LIVE Matches Section -->
                    <div id="liveMatchesSection" class="cc-match-section">
                        <h4 class="cc-section-header">🔴 LIVE Matches</h4>
                        <div id="liveMatchesContainer" class="cc-matches-container">
                            <!-- LIVE match cards will be populated here -->
                        </div>
                    </div>

                    <!-- Front Bracket Matches Section -->
                    <div id="frontMatchesSection" class="cc-match-section">
                        <h4 class="cc-section-header">⚪ Frontside - Ready to Start</h4>
                        <div id="frontMatchesContainer" class="cc-matches-container">
                            <!-- Front bracket ready match cards will be populated here -->
                        </div>
                    </div>

                    <!-- Back Bracket Matches Section -->
                    <div id="backMatchesSection" class="cc-match-section">
                        <h4 class="cc-section-header">⚫ Backside - Ready to Start</h4>
                        <div id="backMatchesContainer" class="cc-matches-container">
                            <!-- Back bracket ready match cards will be populated here -->
                        </div>
                    </div>

                    <!-- Empty state message -->
                    <div id="noMatchesMessage" class="cc-no-matches-message" style="display: none;">
                        <p>No matches currently active or ready to start.</p>
                    </div>
                </div>

                <!-- Referee Suggestions Column -->
                <div class="referee-suggestions-container">
                    <h4 class="cc-section-header">👥 Referee Suggestions</h4>
                    <div class="referee-suggestions-content">
                        <div id="refereeLosersSection" class="referee-section">
                            <h5 class="referee-subsection-header">Recent Losers</h5>
                            <div id="refereeLosersContainer" class="referee-list">
                                <!-- Recent losers will be populated here -->
                            </div>
                        </div>
                        <div id="refereeWinnersSection" class="referee-section">
                            <h5 class="referee-subsection-header">Recent Winners</h5>
                            <div id="refereeWinnersContainer" class="referee-list">
                                <!-- Recent winners will be populated here -->
                            </div>
                        </div>
                        <div id="refereeAssignmentsSection" class="referee-section">
                            <h5 class="referee-subsection-header">Recent Assignments</h5>
                            <div id="refereeAssignmentsContainer" class="referee-list">
                                <!-- Recent referee assignments will be populated here -->
                            </div>
                        </div>
                        <div id="noRefereeSuggestionsMessage" class="referee-empty-message" style="display: none;">
                            <p>No referee suggestions available</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-20">
                <button class="btn" id="commandCenterOK" style="background: #065f46;">Close</button>
            </div>
        </div>
    </div>

    <!-- Undo Confirmation Modal -->
    <div id="undoConfirmModal" class="modal">
        <div class="modal-content">
            <h3 id="undoConfirmTitle">Confirm Match Undo</h3>
            <div id="undoConfirmMessage" style="margin: 20px 0; line-height: 1.5;">
                <!-- Undo confirmation message will be populated by JavaScript -->
            </div>
            <div class="text-center mt-20">
                <button class="btn" id="undoConfirmCancel" style="margin-right: 15px; background: #6c757d; font-weight: 600;">Cancel</button>
                <button class="btn btn-warning" id="undoConfirmOK">Confirm Undo</button>
            </div>
        </div>
    </div>

</body>

</html>
